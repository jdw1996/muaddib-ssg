#!/usr/bin/make -f

MAKEFLAGS += --warn-undefined-variables

BLOG_DIR := _blog
ASSETS_DIR := assets

POST_TEMPLATE := ${BLOG_DIR}/_post.html
POST_SOURCES := $(wildcard ${BLOG_DIR}/*.md)
POSTS := $(addsuffix .html,$(basename $(notdir ${POST_SOURCES})))

MAIN_PAGE_TEMPLATE := ${BLOG_DIR}/_index.html
MAIN_PAGE_SOURCE := ${BLOG_DIR}/index.md
MAIN_PAGE := index.html

STYLESHEET_SOURCE := ${BLOG_DIR}/style.css
STYLESHEET := assets/style.css

.PHONY: all clean

# all: ${MAIN_PAGE} ${POSTS} ${STYLESHEET}

${MAIN_PAGE}: ${MAIN_PAGE_SOURCE} ${MAIN_PAGE_TEMPLATE}
	pandoc ${MAIN_PAGE_SOURCE} -o ${MAIN_PAGE_SOURCE}.tmp
	sed -e '/{{BODY}}/{r ${MAIN_PAGE_SOURCE}.tmp' -e 'd}' ${MAIN_PAGE_TEMPLATE} > ${MAIN_PAGE}
	sed -i -e "s/{{TITLE}}/$$(sed -n -e '1{p;q;}' ${MAIN_PAGE_SOURCE} | sed -n -e 's/<!--\(.*\)-->/\1/p')/g" ${MAIN_PAGE}
	sed -i -e "s/{{DATE}}/$$(sed -n -e '2{p;q;}' ${MAIN_PAGE_SOURCE} | sed -n -e 's/<!--\(.*\)-->/\1/p')/g" ${MAIN_PAGE}
	sed -i -e "s/{{YEAR}}/$$(date +'%Y')/g" ${MAIN_PAGE}
	rm -f ${MAIN_PAGE_SOURCE}.tmp

%.html: ${BLOG_DIR}/%.md
	# TODO: Write.

${STYLESHEET}: ${STYLESHEET_SOURCE}
	# TODO: Write.

clean:
	rm -f ${MAIN_PAGE} ${POSTS} ${STYLESHEET}
