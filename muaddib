#!/usr/bin/make -f

MAKEFLAGS += --warn-undefined-variables

BLOG_DIR := _blog
ASSETS_DIR := assets

POST_TEMPLATE := ${BLOG_DIR}/_post.html
POST_SOURCES := $(wildcard ${BLOG_DIR}/*.md)
POSTS := $(addsuffix .html,$(basename $(notdir ${POST_SOURCES})))

MAIN_PAGE_TEMPLATE := ${BLOG_DIR}/_index.html
MAIN_PAGE_SOURCE := ${BLOG_DIR}/index.md
MAIN_PAGE := index.html

STYLESHEET_SOURCE := ${BLOG_DIR}/_style.css
STYLESHEET := assets/style.css

.PHONY: all clean

all: ${MAIN_PAGE} ${POSTS} ${STYLESHEET}

${MAIN_PAGE}: ${MAIN_PAGE_SOURCE} ${MAIN_PAGE_TEMPLATE}
	pandoc $< -o ${MAIN_PAGE_SOURCE}.tmp
	sed -e "/{{BODY}}/{r $<.tmp" -e "d}" ${MAIN_PAGE_TEMPLATE} > $@
	sed -i -e "s/{{TITLE}}/$$(sed -n -e '1{p;q;}' $< | sed -n -e 's/<!--\(.*\)-->/\1/p')/g" $@
	sed -i -e "s/{{YEAR}}/$$(date +'%Y')/g" $@
	rm -f $<.tmp

%.html: ${BLOG_DIR}/%.md ${POST_TEMPLATE}
	pandoc $< -o $<.tmp
	sed -e "/{{BODY}}/{r $<.tmp" -e "d}" ${POST_TEMPLATE} > $@
	sed -i -e "s/{{TITLE}}/$$(sed -n -e '1{p;q;}' $< | sed -n -e 's/<!--\(.*\)-->/\1/p')/g" $@
	sed -i -e "s/{{DATE}}/$$(sed -n -e '2{p;q;}' $< | sed -n -e 's/<!--\(.*\)-->/\1/p')/g" $@
	sed -i -e "s/{{YEAR}}/$$(date +'%Y')/g" $@
	rm -f $<.tmp

${STYLESHEET}: ${STYLESHEET_SOURCE}
	cp -f $< $@

clean:
	rm -f ${MAIN_PAGE} ${POSTS} ${STYLESHEET}
